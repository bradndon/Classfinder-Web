<html ng-app='classApp'>

<head>
  <title>WWU ClassFinder</title>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.25/angular.min.js"></script>
  <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Lato:700,300' rel='stylesheet' type='text/css'>
  <link href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/css/select2.min.css" rel="stylesheet" />
  <script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/js/select2.min.js"></script>
  <link rel="stylesheet" type="text/css" href="styles/styles.css">
</head>

<body ng-controller="HomeCtrl">
  <div class="sidebar">
    <h1>Subject</h1>
    <select multiple="multiple" class="sidebar__subject subjectSelect"></select>
    <h1>GUR/Course Attribute</h1>
    <select multiple="multiple" class="sidebar__subject gurSelect"></select>
  </div>
  <div class="content">
    <div class="content__class">
      <div style="float:left; width: 40%;">
        <h1 class="content__text content__text--title">class.class - class.title</h1>
        <h2 class="content__text content__text--subtitle">GURS: class.gur</h2>
        <h2 ng-if="class.restrictions" class="content__text content__text--subtitle">Restrictions: {{class.restrictions}}</h2>
        <h2 ng-if="class.prerequisites" class="content__text content__text--subtitle">Prerequisites: {{class.prerequisites}}</h2>
      </div>
      <div style="float:left; display: flex; flex-direction: column;width: 60%;">
        <div class="content__right">
          <div style="width:60%;display: flex;
        justify-content: flex-start;">
            <p class="content__text">cap</p>
            <p class="content__text">enrol</p>
            <p class="content__text">avail</p>
          </div>
          <p style="width:40%;" class="content__text">{{class.inst}}</p>
        </div>
        <div style="font-size:90%;" class="content__right">
          <p style="width:60%;" class="content__text">{{class.time1}}</p>
          <p style="width:40%;" class="content__text">{{class.room1}}</p>
        </div>
        <div style="font-size:90%;" class="content__right">
          <p style="width:60%;" class="content__text">{{class.time2}}</p>
          <p style="width:40%;" class="content__text">{{class.room2}}</p>
        </div>
        <div style="font-size:80%;" class="content__right">
          <p class="content__text">{{class.crn}}</p>
          <p class="content__text">{{class.crenum}}</p>
          <p class="content__text">{{class.addl}}</p>
        </div>
      </div>
    </div>
    <div ng-repeat="(subject,classes) in data">
      <h1 ng-show="filter(classes[0])" style="margin-left:0.6em; font-size: 3.0em;">{{subject}}</h1>
      <div ng-show="filter(class)" ng-repeat="class in classes" class="content__class">
        <div style="float:left; width: 40%;">
          <h2 class="content__text content__text--title">{{class.class}} - {{class.title}}</h1>
          <h3 ng-if="class.gur" class="content__text content__text--subtitle">GURS: {{class.gur}}</h2>
          <h3 ng-if="class.restrictions" class="content__text content__text--subtitle">Restrictions: {{class.restrictions}}</h2>
          <h3 ng-if="class.prerequisites" class="content__text content__text--subtitle">Prerequisites: {{class.prerequisites}}</h2>
        </div>
        <div style="float:left; display: flex; flex-direction: column;width: 60%;">
          <div class="content__right">
            <div style="width:60%;display: flex;
          justify-content: flex-start;">
              <p class="content__text">{{class.cap}}</p>
              <p class="content__text">{{class.enrol}}</p>
              <p class="content__text">{{class.avail}}</p>
            </div>
            <p style="width:40%;" class="content__text">{{class.inst}}</p>
          </div>
          <div style="font-size:90%;" class="content__right">
            <p style="width:60%;" class="content__text">{{class.time1}}</p>
            <p style="width:40%;" class="content__text">{{class.room1}}</p>
          </div>
          <div style="font-size:90%;" class="content__right">
            <p style="width:60%;" class="content__text">{{class.time2}}</p>
            <p style="width:40%;" class="content__text">{{class.room2}}</p>
          </div>
          <div style="font-size:80%;" class="content__right">
            <p class="content__text">{{class.crn}}</p>
            <p class="content__text">{{class.crenum}}</p>
            <p class="content__text">{{class.addl}}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    var classApp = angular.module('classApp', []);
    classApp.controller('HomeCtrl', function($scope) {
      $scope.selected = [];
      $scope.selectedGur = [];
      $scope.ruleset = {"class": [], gur: []};
      $scope.filter = function(currClass) {
        var index = 0;
        var returns = Array.apply(null, Array(2)).map(String.prototype.valueOf,"false");
        for (var rule in $scope.ruleset) {
          if ($scope.ruleset[rule].length == 0) {
            returns[index] = true;
          }
          for (var x in $scope.ruleset[rule]) {
            if ($scope.ruleset[rule].length != 0 && currClass[rule] == null || (currClass[rule] != null && currClass[rule].indexOf($scope.ruleset[rule][x]) <= -1)) {
            } else {
              returns[index] = true;
            }
          }
        index++;
        }
        if (returns.indexOf("false") > -1){
          return false;
        }
        return true;
      }
      $.getJSON("http://localhost:4568/v1/class/201610?apikey=mine", function(data) {
        $scope.allData = data;
        $scope.data = data;
        $scope.$apply();

      });
      $.getJSON("http://localhost:4568/v1/menu?apikey=mine", function(data) {
        $scope.menuData = data;
        var subData = []
        var gurData = []
        for (obj in data.Subject){
            subData.push({id: data.Subject[obj], text: obj});
        }
        for (obj in data["GUR/Course Attribute"]){
            gurData.push({id: data["GUR/Course Attribute"][obj], text: obj});
        }
        subData.sort(function(a, b) {
            return a.text.localeCompare(b.text);
        });
        gurData.sort(function(a, b) {
            return a.text.localeCompare(b.text);
        });
        console.log($scope.menuData);
        $('.subjectSelect').select2({
          data: subData
        });
        $('.subjectSelect').on("select2:select", function (e) {
          $scope.selected.push(e.params.data.text);
          $scope.ruleset["class"].push(e.params.data.id);
          $scope.$apply();
        });
        $('.subjectSelect').on("select2:unselect", function (e) {
          var index = $scope.selected.indexOf(e.params.data.text)
          var i2 =    $scope.ruleset["class"].indexOf(e.params.data.id);

          $scope.selected.splice(index, 1);
          $scope.ruleset["class"].splice(i2, 1);
          $scope.$apply();
        });
        $('.gurSelect').select2({
          data: gurData
        });
        $('.gurSelect').on("select2:select", function (e) {
          $scope.selectedGur.push(e.params.data.id);
          $scope.ruleset.gur.push(e.params.data.id);
          $scope.$apply();
          console.log($scope.ruleset);
        });
        $('.gurSelect').on("select2:unselect", function (e) {
          var index = $scope.selectedGur.indexOf(e.params.data.id)
          var i2 =    $scope.ruleset.gur.indexOf(e.params.data.id);

          $scope.selectedGur.splice(index, 1);
          $scope.ruleset.gur.splice(i2, 1);
          $scope.$apply();
        });
        $scope.$apply();
      });
    });
  </script>
</body>

</html>
